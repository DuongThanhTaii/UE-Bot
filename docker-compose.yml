version: '3.8'

services:
  # ===================
  # Webapp (Next.js)
  # ===================
  webapp:
    build:
      context: .
      dockerfile: packages/webapp/Dockerfile
    container_name: ue-bot-webapp
    restart: unless-stopped
    ports:
      - '3000:3000'
    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_API_URL=http://bridge:8080
      - NEXT_PUBLIC_WS_URL=ws://bridge:8080
    depends_on:
      - bridge
    networks:
      - ue-bot-network
    healthcheck:
      test: ['CMD', 'wget', '-q', '--spider', 'http://localhost:3000/api/health']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ===================
  # Bridge Service
  # ===================
  bridge:
    build:
      context: .
      dockerfile: packages/bridge-service/Dockerfile
    container_name: ue-bot-bridge
    restart: unless-stopped
    ports:
      - '8080:8080'
    environment:
      - NODE_ENV=production
      - PORT=8080
      - MOLTBOT_URL=${MOLTBOT_URL:-http://moltbot:3001}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ELEVENLABS_API_KEY=${ELEVENLABS_API_KEY}
    networks:
      - ue-bot-network
    healthcheck:
      test: ['CMD', 'wget', '-q', '--spider', 'http://localhost:8080/health']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ===================
  # Moltbot (Clawdbot clone)
  # ===================
  moltbot:
    build:
      context: ./external/moltbot
      dockerfile: Dockerfile
    container_name: ue-bot-moltbot
    restart: unless-stopped
    ports:
      - '3001:3001'
    environment:
      - NODE_ENV=production
      - PORT=3001
    env_file:
      - .env
    networks:
      - ue-bot-network
    volumes:
      - moltbot-data:/app/data

  # ===================
  # Redis (Optional - for caching)
  # ===================
  redis:
    image: redis:7-alpine
    container_name: ue-bot-redis
    restart: unless-stopped
    ports:
      - '6379:6379'
    networks:
      - ue-bot-network
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes

  # ===================
  # Telegram Bot
  # ===================
  telegram-bot:
    build:
      context: .
      dockerfile: packages/telegram-bot/Dockerfile
    container_name: ue-bot-telegram
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - GROQ_API_KEY=${GROQ_API_KEY}
      - GROQ_MODEL=${GROQ_MODEL:-llama-3.3-70b-versatile}
      - BRAVE_SEARCH_API_KEY=${BRAVE_SEARCH_API_KEY:-}
      - DATA_DIR=/app/data
    networks:
      - ue-bot-network
    volumes:
      - telegram-data:/app/data

networks:
  ue-bot-network:
    driver: bridge

volumes:
  moltbot-data:
  redis-data:
  telegram-data:
